name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron:  '0 0 * * *'

env:
  build_dir: ${{ github.workspace }}/output

jobs:
  build:
    name: Building ${{ matrix.toolchain.target }} toolchain
    runs-on: ubuntu-18.04

    strategy:
      fail-fast: false
      matrix:
        toolchain:
          - target: arc64-elf
            mode: newlib
          - target: arc64-linux
            mode: linux

    steps:
      - uses: actions/checkout@v2
      - name: Install apt dependencies
        run: |
          sudo apt-get -y update
          sudo apt-get install -y --no-install-recommends \
            autoconf \
            automake \
            autotools-dev \
            bc \
            bison \
            build-essential \
            curl \
            flex \
            gawk \
            gperf \
            libgmp-dev \
            libmpc-dev \
            libmpfr-dev \
            libtool \
            patchutils \
            texinfo

      - name: Build toolchain
        id: build_toolchain
        run: |
          echo "::set-output name=toolchain_name::${{ matrix.toolchain.target }}-nightly-$(date --utc '+%Y.%m.%d')"

          ./configure \
            --target=${{ matrix.toolchain.target }} \
            --prefix=${{ env.build_dir }} \
            --disable-multilib \
            --disable-qemu \
            --disable-werror

          make ${{ matrix.toolchain.mode }} -j$(nproc)

      - name: Create toolchain archive
        if: github.event_name == 'schedule'
        run: |
          tar -czvf ${{ steps.build_toolchain.outputs.toolchain_name }}.tar.gz --owner=0 --group=0 -C ${{ env.build_dir }} .

      - name: Upload artifacts
        if: github.event_name == 'schedule'
        uses: actions/upload-artifact@v2
        with:
          name: ${{ steps.build_toolchain.outputs.toolchain_name }}
          path: ${{ steps.build_toolchain.outputs.toolchain_name }}.tar.gz
